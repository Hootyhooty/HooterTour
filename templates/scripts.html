<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='lib/wow/wow.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/easing/easing.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/waypoints/waypoints.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/owlcarousel/owl.carousel.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/moment.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/moment-timezone.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<script>
    $(document).ready(function() {
        let isRegisterDropdownOpen = false;
        let isLogoutDropdownOpen = false;

        function checkAuthStatus() {
            $.ajax({
                url: '/api/v1/users/me',
                method: 'GET',
                xhrFields: { withCredentials: true }, // Send cookies with request
                success: function(response) {
                    console.log('Auth check success:', response); // Debug
                    const user = response.data.data;
                    const userId = user.id;
                    const profileSlug = user.profile_slug;
                    console.log('User ID:', userId, 'Profile Slug:', profileSlug);

                    const userPhoto = user.photo && user.photo !== 'default.jpg' ? `/api/v1/users/image/${profileSlug}` : "{{ url_for('serve_static_image', filename='placeholder.jpg') | e }}";
                    const $userImage = $('<img>', {
                        src: userPhoto,
                        alt: 'User Image',
                        class: 'user-image rounded-circle',
                        style: 'width: 40px; height: 40px; object-fit: cover;'
                    });
                    const $logoutDropdown = $('<div>', {
                        class: 'logout-dropdown',
                        html: `
                            <a href="/dashboard/${profileSlug}" class="btn btn-primary d-block mb-2" id="edit-profile-btn">Edit Profile</a>
                            <button type="button" class="btn btn-primary" id="logout-btn">Logout</button>
                        `
                    });

                    $('.register-btn-wrapper').html('').append($userImage, $logoutDropdown);

                    $userImage.off('click').on('click', function(e) {
                        e.preventDefault();
                        isLogoutDropdownOpen = !isLogoutDropdownOpen;
                        $logoutDropdown.toggleClass('active', isLogoutDropdownOpen);
                    });

                    $('#logout-btn').off('click').on('click', function(e) {
                        e.preventDefault();
                        $.ajax({
                            url: '/api/v1/users/logout',
                            method: 'GET',
                            xhrFields: { withCredentials: true },
                            success: function(response) {
                                setupRegisterButton();
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 500);
                            },
                            error: function(xhr) {
                                setupRegisterButton();
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 500);
                            }
                        });
                    });

                    $('#edit-profile-btn').off('click').on('click', function(e) {
                        e.preventDefault();
                        window.location.href = `/dashboard/${profileSlug}`;
                    });
                },
                error: function(xhr) {
                    console.error('Auth check failed:', xhr.status, xhr.responseText);
                    setupRegisterButton();
                }
            });
        }

        function setupRegisterButton() {
            const $registerButton = $('<a>', {
                href: '#',
                class: 'btn btn-primary rounded-pill py-2 px-4 register-btn',
                text: 'Sign in / Sign up'
            });
            const $registerDropdown = $('<div>', {
                class: 'register-dropdown',
                html: `
                    <div id="email-entry-form">
                        <input type="email" class="form-control" id="register-email" placeholder="Enter your email">
                        <button type="button" class="btn btn-primary" id="check-email-btn">Enter with Email</button>
                    </div>
                    <div id="login-form" style="display: none;">
                        <div class="error-message" id="login-error"></div>
                        <input type="email" class="form-control" id="login-email" readonly>
                        <input type="password" class="form-control" id="login-password" placeholder="Password">
                        <button type="button" class="btn btn-primary" id="login-btn">Login</button>
                        <button type="button" class="btn btn-link" id="back-to-email">Back</button>
                    </div>
                    <div id="signup-form" style="display: none;">
                        <div class="error-message" id="signup-error"></div>
                        <input type="email" class="form-control" id="signup-email" readonly>
                        <input type="text" class="form-control" id="signup-name" placeholder="Username">
                        <input type="password" class="form-control" id="signup-password" placeholder="Password">
                        <input type="password" class="form-control" id="signup-confirm-password" placeholder="Confirm Password">
                        <button type="button" class="btn btn-primary" id="signup-btn">Sign Up</button>
                        <button type="button" class="btn btn-link" id="back-to-email-signup">Back</button>
                    </div>
                `
            });

            $('.register-btn-wrapper').html('').append($registerButton, $registerDropdown);
            $('.register-dropdown').removeClass('active');
            isRegisterDropdownOpen = false;

            $registerButton.off('click.register').on('click.register', function(e) {
                e.preventDefault();
                console.log('Register button clicked');
                isRegisterDropdownOpen = !isRegisterDropdownOpen;
                $('.register-dropdown').toggleClass('active', isRegisterDropdownOpen);
            });

            $('#check-email-btn').off('click').on('click', function() {
                const email = $('#register-email').val().trim();
                if (!email) {
                    alert('Please enter an email address');
                    return;
                }
                $.ajax({
                    url: '/api/v1/users/check-email',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ email: email }),
                    xhrFields: { withCredentials: true },
                    success: function(response) {
                        $('#email-entry-form').hide();
                        if (response.exists) {
                            $('#login-email').val(email);
                            $('#login-form').show();
                        } else {
                            $('#signup-email').val(email);
                            $('#signup-form').show();
                        }
                    },
                    error: function(xhr) {
                        alert('Failed to check email: ' + (xhr.responseJSON?.message || 'Unknown issue'));
                    }
                });
            });

            $('#back-to-email').off('click').on('click', function() {
                $('#login-form').hide();
                $('#email-entry-form').show();
                $('#register-email').val('');
                $('#login-error').hide();
            });

            $('#back-to-email-signup').off('click').on('click', function() {
                $('#signup-form').hide();
                $('#email-entry-form').show();
                $('#register-email').val('');
                $('#signup-error').hide();
            });

            $('#login-btn').off('click').on('click', function() {
                const email = $('#login-email').val();
                const password = $('#login-password').val();
                if (!password) {
                    $('#login-error').text('Password is required').show();
                    return;
                }
                $.ajax({
                    url: '/api/v1/users/login',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ email: email, password: password }),
                    xhrFields: { withCredentials: true },
                    success: function(response) {
                        // No need to store token in localStorage; backend sets httponly cookie
                        checkAuthStatus();
                    },
                    error: function(xhr) {
                        $('#login-error').text(xhr.responseJSON?.message || 'Login failed').show();
                    }
                });
            });

            $('#signup-btn').off('click').on('click', function() {
                const email = $('#signup-email').val();
                const name = $('#signup-name').val();
                const password = $('#signup-password').val();
                const confirmPassword = $('#signup-confirm-password').val();
                if (!name || !password || !confirmPassword) {
                    $('#signup-error').text('All fields are required').show();
                    return;
                }
                if (password !== confirmPassword) {
                    $('#signup-error').text('Passwords do not match').show();
                    return;
                }
                $.ajax({
                    url: '/api/v1/users/signup',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        email: email,
                        name: name,
                        password: password,
                        passwordConfirm: confirmPassword
                    }),
                    xhrFields: { withCredentials: true },
                    success: function(response) {
                        // No need to store token in localStorage; backend sets httponly cookie
                        checkAuthStatus();
                    },
                    error: function(xhr) {
                        $('#signup-error').text(xhr.responseJSON?.message || 'Signup failed').show();
                    }
                });
            });
        }

        $(document).on('click', function(e) {
            const $registerButton = $('.register-btn');
            const $userImage = $('.user-image');
            const $registerDropdown = $('.register-dropdown');
            const $logoutDropdown = $('.logout-dropdown');
            if ($registerButton.length && !$registerButton.is(e.target) && !$registerButton.has(e.target).length && $registerDropdown.length && !$registerDropdown.has(e.target).length) {
                isRegisterDropdownOpen = false;
                $registerDropdown.removeClass('active');
            }
            if ($userImage.length && !$userImage.is(e.target) && !$userImage.has(e.target).length && $logoutDropdown.length && !$logoutDropdown.has(e.target).length) {
                isLogoutDropdownOpen = false;
                $logoutDropdown.removeClass('active');
            }
        });

        try {
            checkAuthStatus();
        } catch (err) {
            console.error('Auth check failed:', err);
            setupRegisterButton();
        }

        // Initialize WOW.js
        new WOW().init();

        // Nav link highlighting
        const currentPath = window.location.pathname;
        $('.nav-item a').each(function() {
            const linkPath = $(this).attr('data-path');
            if (linkPath && currentPath === linkPath) {
                $(this).addClass('active');
            }
        });
    });
</script>