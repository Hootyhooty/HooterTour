{% extends "base.html" %}

{% block content %}
    <div class="container-xxl py-5">
        <div class="container">
            <div class="text-center pb-4 wow fadeInUp" data-wow-delay="0.1s">
                <h6 class="section-title bg-white text-center text-primary px-3">Secure Checkout</h6>
                <h1 class="mb-5">Payment for {{ tour.name | default('Unknown Tour', true) }}</h1>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-8 wow fadeInUp" data-wow-delay="0.3s">
                    {% if tour and booking_id and session %}
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <!-- Tour Summary -->
                                    <div class="col-md-6">
                                        <h4 class="mb-3">Order Summary</h4>
                                        <p><strong>Tour:</strong> {{ tour.name }}</p>
                                        <p><strong>Price:</strong> ${{ "%.2f" | format(tour.price | default(0)) }}</p>
                                        <p><strong>Currency:</strong> {{ session.currency | default('USD') }}</p>
                                        <p><strong>Session ID:</strong> {{ session.id }}</p>
                                        <p><strong>Email:</strong> {{ g.user.email if g.user else 'Not available' }}</p>
                                        <hr>
                                        <p class="text-muted">This is a mock payment page for portfolio purposes. Payment will be simulated without requiring card details.</p>
                                    </div>
                                    <!-- Payment Form -->
                                    <div class="col-md-6">
                                        <h4 class="mb-3">Payment Details</h4>
                                        <form id="payment-form" action="{{ url_for('view_routes.mock_payment_success') }}" method="POST">
                                            {{ form.hidden_tag() }} <!-- CSRF token -->
                                            <input type="hidden" name="booking_id" value="{{ booking_id }}">
                                            <input type="hidden" name="session_id" value="{{ session.id }}">
                                            <div class="row">
                                                <div class="col">
                                                    <div class="form-group mb-3">
                                                        <label for="card-number" class="form-label">Card Number</label>
                                                        <input type="text" class="form-control" id="card-number" name="card_number" placeholder="4242 4242 4242 4242">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col">
                                                    <div class="form-group mb-3">
                                                        <label for="expiry" class="form-label">Expiry</label>
                                                        <input type="text" class="form-control" id="expiry" name="expiry" placeholder="MM/YY">
                                                    </div>
                                                </div>
                                                <div class="col">
                                                    <div class="form-group mb-3">
                                                        <label for="cvc" class="form-label">CVC</label>
                                                        <input type="text" class="form-control" id="cvc" name="cvc" placeholder="123">
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary rounded-pill py-2 px-4 mt-3" id="pay-button" aria-label="Complete Mock Payment">
                                                <span id="button-text">Pay Now</span>
                                                <span id="loading" class="d-none"><i class="fas fa-spinner fa-spin"></i> Processing...</span>
                                            </button>
                                            <a href="{{ url_for('view_routes.get_tour_by_slug', slug=tour.slug) }}" class="btn btn-secondary rounded-pill py-2 px-4 mt-3" aria-label="Cancel Payment">Cancel</a>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-danger text-center" role="alert">
                            Unable to process payment: Tour, booking, or session information is missing.
                        </div>
                        <div class="text-center mt-3">
                            <a href="{{ url_for('view_routes.home') }}" class="btn btn-secondary rounded-pill py-2 px-4" aria-label="Return to Home">Return to Home</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Loading Animation -->
    <script>
        document.getElementById('payment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const payButton = document.getElementById('pay-button');
            const buttonText = document.getElementById('button-text');
            const loading = document.getElementById('loading');
            payButton.disabled = true;
            buttonText.classList.add('d-none');
            loading.classList.remove('d-none');
            setTimeout(() => {
                this.submit();
            }, 1500); // Simulate 1.5s payment processing delay
        });
    </script>
{% endblock %}